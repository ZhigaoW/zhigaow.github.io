<!DOCTYPE html>
<html>

<head>
    <title>plan9.md</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">

    <style>
        /* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
        /*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

        body {
            font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
            font-size: var(--vscode-markdown-font-size, 14px);
            padding: 0 26px;
            line-height: var(--vscode-markdown-line-height, 22px);
            word-wrap: break-word;
        }

        #code-csp-warning {
            position: fixed;
            top: 0;
            right: 0;
            color: white;
            margin: 16px;
            text-align: center;
            font-size: 12px;
            font-family: sans-serif;
            background-color: #444444;
            cursor: pointer;
            padding: 6px;
            box-shadow: 1px 1px 1px rgba(0, 0, 0, .25);
        }

        #code-csp-warning:hover {
            text-decoration: none;
            background-color: #007acc;
            box-shadow: 2px 2px 2px rgba(0, 0, 0, .25);
        }

        body.scrollBeyondLastLine {
            margin-bottom: calc(100vh - 22px);
        }

        body.showEditorSelection .code-line {
            position: relative;
        }

        body.showEditorSelection .code-active-line:before,
        body.showEditorSelection .code-line:hover:before {
            content: "";
            display: block;
            position: absolute;
            top: 0;
            left: -12px;
            height: 100%;
        }

        body.showEditorSelection li.code-active-line:before,
        body.showEditorSelection li.code-line:hover:before {
            left: -30px;
        }

        .vscode-light.showEditorSelection .code-active-line:before {
            border-left: 3px solid rgba(0, 0, 0, 0.15);
        }

        .vscode-light.showEditorSelection .code-line:hover:before {
            border-left: 3px solid rgba(0, 0, 0, 0.40);
        }

        .vscode-light.showEditorSelection .code-line .code-line:hover:before {
            border-left: none;
        }

        .vscode-dark.showEditorSelection .code-active-line:before {
            border-left: 3px solid rgba(255, 255, 255, 0.4);
        }

        .vscode-dark.showEditorSelection .code-line:hover:before {
            border-left: 3px solid rgba(255, 255, 255, 0.60);
        }

        .vscode-dark.showEditorSelection .code-line .code-line:hover:before {
            border-left: none;
        }

        .vscode-high-contrast.showEditorSelection .code-active-line:before {
            border-left: 3px solid rgba(255, 160, 0, 0.7);
        }

        .vscode-high-contrast.showEditorSelection .code-line:hover:before {
            border-left: 3px solid rgba(255, 160, 0, 1);
        }

        .vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
            border-left: none;
        }

        img {
            max-width: 40%;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        a:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 1px solid -webkit-focus-ring-color;
            outline-offset: -1px;
        }

        hr {
            border: 0;
            height: 2px;
            border-bottom: 2px solid;
        }

        h1 {
            padding-bottom: 0.3em;
            line-height: 1.2;
            border-bottom-width: 1px;
            border-bottom-style: solid;
        }

        h1,
        h2,
        h3 {
            font-weight: normal;
        }

        table {
            border-collapse: collapse;
        }

        table>thead>tr>th {
            text-align: left;
            border-bottom: 1px solid;
        }

        table>thead>tr>th,
        table>thead>tr>td,
        table>tbody>tr>th,
        table>tbody>tr>td {
            padding: 5px 10px;
        }

        table>tbody>tr+tr>td {
            border-top: 1px solid;
        }

        blockquote {
            margin: 0 7px 0 5px;
            padding: 0 16px 0 10px;
            border-left-width: 5px;
            border-left-style: solid;
        }

        code {
            font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
            font-size: 1em;
            line-height: 1.357em;
        }

        body.wordWrap pre {
            white-space: pre-wrap;
        }

        pre:not(.hljs),
        pre.hljs code>div {
            padding: 16px;
            border-radius: 3px;
            overflow: auto;
        }

        pre code {
            color: var(--vscode-editor-foreground);
            tab-size: 4;
        }

        /** Theming */

        .vscode-light pre {
            background-color: rgba(220, 220, 220, 0.4);
        }

        .vscode-dark pre {
            background-color: rgba(10, 10, 10, 0.4);
        }

        .vscode-high-contrast pre {
            background-color: rgb(0, 0, 0);
        }

        .vscode-high-contrast h1 {
            border-color: rgb(0, 0, 0);
        }

        .vscode-light table>thead>tr>th {
            border-color: rgba(0, 0, 0, 0.69);
        }

        .vscode-dark table>thead>tr>th {
            border-color: rgba(255, 255, 255, 0.69);
        }

        .vscode-light h1,
        .vscode-light hr,
        .vscode-light table>tbody>tr+tr>td {
            border-color: rgba(0, 0, 0, 0.18);
        }

        .vscode-dark h1,
        .vscode-dark hr,
        .vscode-dark table>tbody>tr+tr>td {
            border-color: rgba(255, 255, 255, 0.18);
        }
    </style>

    <style>
        /* Tomorrow Theme */
        /* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
        /* Original theme - https://github.com/chriskempson/tomorrow-theme */

        /* Tomorrow Comment */
        .hljs-comment,
        .hljs-quote {
            color: #8e908c;
        }

        /* Tomorrow Red */
        .hljs-variable,
        .hljs-template-variable,
        .hljs-tag,
        .hljs-name,
        .hljs-selector-id,
        .hljs-selector-class,
        .hljs-regexp,
        .hljs-deletion {
            color: #c82829;
        }

        /* Tomorrow Orange */
        .hljs-number,
        .hljs-built_in,
        .hljs-builtin-name,
        .hljs-literal,
        .hljs-type,
        .hljs-params,
        .hljs-meta,
        .hljs-link {
            color: #f5871f;
        }

        /* Tomorrow Yellow */
        .hljs-attribute {
            color: #eab700;
        }

        /* Tomorrow Green */
        .hljs-string,
        .hljs-symbol,
        .hljs-bullet,
        .hljs-addition {
            color: #718c00;
        }

        /* Tomorrow Blue */
        .hljs-title,
        .hljs-section {
            color: #4271ae;
        }

        /* Tomorrow Purple */
        .hljs-keyword,
        .hljs-selector-tag {
            color: #8959a8;
        }

        .hljs {
            display: block;
            overflow-x: auto;
            color: #4d4d4c;
            padding: 0.5em;
        }

        .hljs-emphasis {
            font-style: italic;
        }

        .hljs-strong {
            font-weight: bold;
        }
    </style>

    <style>
        /*
 * Markdown PDF CSS
 */

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
            padding: 0 12px;
        }

        pre {
            background-color: #f8f8f8;
            border: 1px solid #cccccc;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        pre:not(.hljs) {
            padding: 23px;
            line-height: 19px;
        }

        blockquote {
            background: rgba(127, 127, 127, 0.1);
            border-color: rgba(0, 122, 204, 0.5);
        }

        .emoji {
            height: 1.4em;
        }

        code {
            font-size: 14px;
            line-height: 19px;
        }

        /* for inline code */
        :not(pre):not(.hljs)>code {
            color: #C9AE75;
            /* Change the old color so it seems less like an error */
            font-size: inherit;
        }

        /* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
        .page {
            page-break-after: always;
        }
    </style>

    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>

<body>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
                ? 'dark'
                : 'default'
        });
    </script>
    <p><strong><a href="../README.md">BACK</a></strong></p>
    <hr>
    <h1 id="plan9%E6%B1%87%E7%BC%96">PLAN9汇编</h1>
    <h2 id="%E5%89%8D%E8%A8%80">前言</h2>
    <p>汇编语言可以直接翻译为机器语言，即0和1组成的串。GO底层的汇编使用的基本上是PLAN9汇编的语法，汇编语言之间可以相互转化，所以PLAN9只要有合理的映射就可以直接转换为机器语言。</p>
    <h2 id="%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%A7%84%E7%BA%A6">函数的调用规约</h2>
    <p>调用规约: 一个<strong>高级语言</strong>的调用规约就是函数的参数和返回值以<strong>什么样的顺序和规则放在内存或者寄存器中</strong></p>
    <p>参考<a href="https://gitbook.coder.cat/function-call-principle/">C语言的调用规约</a></p>
    <pre class="hljs"><code><div><span class="hljs-comment">// hello.c</span>

<span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">callee</span><span class="hljs-params">(<span class="hljs-keyword">long</span> arg1, <span class="hljs-keyword">long</span> arg2, <span class="hljs-keyword">long</span> arg3, <span class="hljs-keyword">long</span> arg4, <span class="hljs-keyword">long</span> arg5, <span class="hljs-keyword">long</span> arg6, <span class="hljs-keyword">long</span> arg7, <span class="hljs-keyword">long</span> arg8)</span> </span>{
    <span class="hljs-keyword">return</span> arg7 + arg8;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">long</span> a = <span class="hljs-number">7</span>;
    <span class="hljs-keyword">long</span> b = <span class="hljs-number">8</span>;
    callee(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span> ,<span class="hljs-number">5</span> ,<span class="hljs-number">6</span>, a, b);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
    <p>使用<code>gcc hello.c -S</code>输出</p>
    <pre class="hljs"><code><div>        .file   &quot;hello.c&quot;
        .text
        .globl  callee
        .type   callee, @function
callee:
.LFB0:
        .cfi_startproc
        pushq   %rbp
        .cfi_def_cfa_offset 16
        .cfi_offset 6, -16
        movq    %rsp, %rbp
        .cfi_def_cfa_register 6
        movq    %rdi, -8(%rbp)
        movq    %rsi, -16(%rbp)
        movq    %rdx, -24(%rbp)
        movq    %rcx, -32(%rbp)
        movq    %r8, -40(%rbp)
        movq    %r9, -48(%rbp)
        movq    16(%rbp), %rdx
        movq    24(%rbp), %rax
        addq    %rdx, %rax
        popq    %rbp
        .cfi_def_cfa 7, 8
        ret
        .cfi_endproc
.LFE0:
        .size   callee, .-callee
        .globl  main
        .type   main, @function
main:
.LFB1:
        .cfi_startproc
        pushq   %rbp
        .cfi_def_cfa_offset 16
        .cfi_offset 6, -16
        movq    %rsp, %rbp
        .cfi_def_cfa_register 6
        subq    $16, %rsp
        movq    $7, -8(%rbp)
        movq    $8, -16(%rbp)
        pushq   -16(%rbp)
        pushq   -8(%rbp)
        movl    $6, %r9d
        movl    $5, %r8d
        movl    $4, %ecx
        movl    $3, %edx
        movl    $2, %esi
        movl    $1, %edi
        call    callee
        addq    $16, %rsp
        movl    $0, %eax
        leave
        .cfi_def_cfa 7, 8
        ret
        .cfi_endproc
.LFE1:
        .size   main, .-main
        .ident  &quot;GCC: (GNU) 8.5.0 20210514 (Red Hat 8.5.0-4)&quot;
        .section        .note.GNU-stack,&quot;&quot;,@progbits
</div></code></pre>
    <h4 id="c%E7%9A%84main%E5%87%BD%E6%95%B0">C的main函数</h4>
    <pre class="hljs"><code><div>main:
.LFB1:
        .cfi_startproc
        pushq   %rbp
        .cfi_def_cfa_offset 16
        .cfi_offset 6, -16
        movq    %rsp, %rbp
        .cfi_def_cfa_register 6
        subq    $16, %rsp
        movq    $7, -8(%rbp)
        movq    $8, -16(%rbp)
        pushq   -16(%rbp)
        pushq   -8(%rbp)
        movl    $6, %r9d
        movl    $5, %r8d
        movl    $4, %ecx
        movl    $3, %edx
        movl    $2, %esi
        movl    $1, %edi
        call    callee
        addq    $16, %rsp
        movl    $0, %eax
        leave
        .cfi_def_cfa 7, 8
        ret
        .cfi_endproc
.LFE1:
        .size   main, .-main
        .ident  &quot;GCC: (GNU) 8.5.0 20210514 (Red Hat 8.5.0-4)&quot;
        .section        .note.GNU-stack,&quot;&quot;,@progbits
</div></code></pre>
    <p>据说main函数被系统的_start函数调用，main函数将_strat函数的栈基地址寄存器(rbp)押入栈中，将rbp附值为rsp</p>
    <pre class="hljs"><code><div>pushq   %rbp
movq    %rsp, %rbp
</div></code></pre>
    <img src="picture/cstack/Canvas%202.png" width="300" />
    <pre class="hljs"><code><div>        subq    $16, %rsp
        movq    $7, -8(%rbp)
        movq    $8, -16(%rbp)
</div></code></pre>
    <img src="picture/cstack/Canvas%203.png" width="300" />
    <pre class="hljs"><code><div>        pushq   -16(%rbp)
        pushq   -8(%rbp)
        movl    $6, %r9d
        movl    $5, %r8d
        movl    $4, %ecx
        movl    $3, %edx
        movl    $2, %esi
        movl    $1, %edi
</div></code></pre>
    <img src="picture/cstack/Canvas%204.png" width="300" />
    <pre class="hljs"><code><div>        call    callee
</div></code></pre>
    <img src="picture/cstack/Canvas%205.png" width="300" />
    <pre class="hljs"><code><div>callee:
.LFB0:
        .cfi_startproc
        pushq   %rbp
        .cfi_def_cfa_offset 16
        .cfi_offset 6, -16
        movq    %rsp, %rbp
</div></code></pre>
    <img src="picture/cstack/Canvas%206.png" width="300" />
    <pre class="hljs"><code><div>        .cfi_def_cfa_register 6
        movq    %rdi, -8(%rbp)
        movq    %rsi, -16(%rbp)
        movq    %rdx, -24(%rbp)
        movq    %rcx, -32(%rbp)
        movq    %r8, -40(%rbp)
        movq    %r9, -48(%rbp)
        movq    16(%rbp), %rdx
        movq    24(%rbp), %rax
        addq    %rdx, %rax
        popq    %rbp
        .cfi_def_cfa 7, 8
</div></code></pre>
    <img src="picture/cstack/Canvas%207.png" width="300" />
    <pre class="hljs"><code><div>        ret
        .cfi_endproc
</div></code></pre>
    <img src="picture/cstack/Canvas%208.png" width="300" />
    <pre class="hljs"><code><div>        addq    $16, %rsp
        movl    $0, %eax
        leave
        .cfi_def_cfa 7, 8
        ret
        .cfi_endproc
.LFE1:
        .size   main, .-main
        .ident  &quot;GCC: (GNU) 8.5.0 20210514 (Red Hat 8.5.0-4)&quot;
        .section        .note.GNU-stack,&quot;&quot;,@progbits
</div></code></pre>
    <img src="picture/cstack/Canvas%209.png" width="300" />
    <h3 id="go%E7%9A%84%E8%B0%83%E7%94%A8%E8%A7%84%E7%BA%A6">GO的调用规约</h3>
    <pre class="hljs"><code><div>                                                                                                                              
                                       caller                                                                                 
                                 +------------------+                                                                         
                                 |                  |                                                                         
       +----------------------&gt;  --------------------                                                                         
       |                         |                  |                                                                         
       |                         | caller parent BP |                                                                         
       |           BP(pseudo SP) --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   Local Var0     |                                                                         
       |                         --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   .......        |                                                                         
       |                         --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   Local VarN     |                                                                         
                                 --------------------                                                                         
 caller stack frame              |                  |                                                                         
                                 |   callee arg2    |                                                                         
       |                         |------------------|                                                                         
       |                         |                  |                                                                         
       |                         |   callee arg1    |                                                                         
       |                         |------------------|                                                                         
       |                         |                  |                                                                         
       |                         |   callee arg0    |                                                                         
       |                         ----------------------------------------------+   FP(virtual register)                       
       |                         |                  |                          |                                              
       |                         |   return addr    |  parent return address   |                                              
       +----------------------&gt;  +------------------+---------------------------    &lt;-------------------------------+         
                                                    |  caller BP               |                                    |         
                                                    |  (caller frame pointer)  |                                    |         
                                     BP(pseudo SP)  ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |     Local Var0           |                                    |         
                                                    ----------------------------                                    |         
                                                    |                          |                                              
                                                    |     Local Var1           |                                              
                                                    ----------------------------                            callee stack frame
                                                    |                          |                                              
                                                    |       .....              |                                              
                                                    ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |     Local VarN           |                                    |         
                                  SP(Real Register) ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    +--------------------------+    &lt;-------------------------------+         
                                                                                                                              
                                                              callee

                                    
</div></code></pre>
    <h2 id="plan9%E7%9A%84%E6%B1%87%E7%BC%96%E8%AF%AD%E6%B3%95">PLAN9的汇编语法</h2>
    <h3 id="%E5%B7%A5%E5%85%B7">工具</h3>
    <p><a href="https://pkg.go.dev/cmd/compile">go tool compile</a> xxx.go：将go代码编译为obj文件</p>
    <p><a href="https://pkg.go.dev/cmd/objdump">go tool objdump</a> xxx.o`：可以将obj文件反汇编为plan汇编代码</p>
    <h3 id="%E8%AF%AD%E6%B3%95">语法</h3>
    <p>参考<a href="https://xargin.com/plan9-assembly/">plan9入门</a></p>
    <p>// TODO</p>
    <p><img src="picture/func.png" alt=""></p>

</body>

</html>
